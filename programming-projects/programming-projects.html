<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/header.css">
    <link rel="stylesheet" href="../css/body.css">
    <title>Mason's Portfolio Site | Programming Projects</title>
</head>
<body>
    <div id="header">
        <nav>
            <div id="nav-menu">
                <ul>
                    <li class="nav-link"><a href="../index.html">Home</a></li>
                    <li class="nav-link"><a href="#">Programming Projects</a></li>
                    <li class="nav-link"><a href="../nick/nick.html">Nick</a></li>
                    <!-- <li class="nav"><a href=""></a></li> -->
                </ul>
            </div>
        </nav>
        <h1>Programming Projects</h1>
    </div>
    <div id="body">
        <table id="projects-table">
            <tr>
                <th>Active</th>
                <th>Complete</th>
            </tr>
        </table>
    </div>
</body>

<script type="module" type="text/javascript">
// init octokit
import { Octokit, App } from "https://esm.sh/octokit";
const octokit = new Octokit({
    auth: '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'  // THIS IS JUST A PUBLIC_REPO KEY!
});

// variables
const username = "mwhicks-dev";
const active_repositories = [ "registrar", "mwhicks-dev.github.io" ];
const complete_repositories = [];

// functions
function createTable() {
    var active_len = parseInt( active_repositories.length );
    var complete_len = parseInt( complete_repositories.len );

    if ( Number.isNaN( active_len ) )  active_len = 0;
    if ( Number.isNaN( complete_len ) )  complete_len = 0;

    const table_height = active_len > complete_len ? active_len : complete_len;

    const table = document.getElementById("projects-table")
    for ( var i = 0; i < table_height; i++ ) {
        var row = document.createElement("tr");
        var activeColumn = document.createElement("td");
        var completeColumn = document.createElement("td");

        if ( i < active_len ) { activeColumn.id = active_repositories[ i ]; }
        if ( i < complete_len ) { activeColumn.id = complete_repositories[ i ]; }

        row.appendChild( activeColumn );
        row.appendChild( completeColumn );

        table.appendChild( row );
    }
}

async function accessGitAPI( repository ) {
    var info = await octokit.request("GET /repos/{owner}/{repo}",{
        owner: username,
        repo: repository
    });
    var merged_pulls = await octokit.request("GET /repos/{owner}/{repo}/pulls?state=closed",{
        owner: username,
        repo: repository
    });
    var languages = await octokit.request("GET /repos/{owner}/{repo}/languages",{
        owner: username,
        repo: repository
    });

    return {
        info, merged_pulls, languages
    };
}

async function makeLanguagesPercentage( languages ) {
    const keys = Object.keys( languages );

    var total = 0;
    for ( i in keys ) {
        const key = keys[ i ];
        total += parseInt( languages[ key ] );
    }
    for ( i in keys ) {
        const key = keys[ i ];
        languages[ key ] = ( parseInt( 100 * parseInt( languages[ key ] ) / total ) ) + "%";
    }
}

async function addTableElement( repository ) {

    // get repo using async API function
    const gitrepo = await accessGitAPI( repository );

    // create HTML for repository name
    const name = gitrepo.info.data.name;
    const nameString = "<p>Project Title: " + name + "</p>";

    // create HTML for repository description if it exists
    const desc = gitrepo.info.data.description;
    const descString = desc == null ? "" : "<li>Project Description: " + desc + "</li>";

    // create HTML for repository langauges
    var languages = gitrepo.languages.data
    await makeLanguagesPercentage( languages );
    var languagesString = "<li>Languages:<ul>";

    const languages_keys = Object.keys( languages );
    for ( i in languages_keys ) {
        const key = languages_keys[ i ];
        const val = languages[ key ];
        languagesString += "<li>" + key + ": " + ( val == "0%" ? "<1%" : val ) + "</li>";
    }
    languagesString += "</ul></li>";

    // create HTML for deployed homepage if it exists
    const website = gitrepo.info.data.homepage;
    const websiteString = website == "" ? "" : "<li>Deployed Website: <a href=\">" + website + "\">" + website + "</a></li>"

    // create HTML for latest pull
    const merged_pulls = gitrepo.merged_pulls.data;
    var pull_string = "";
    if ( merged_pulls.length > 0 ) {
        const latest_pull = merged_pulls[ 0 ];
        pull_string += "<li><p>Latest Pull: " + latest_pull.title + "</p><p>" + latest_pull.body + "</p></li>";
    }

    // create HTML for public githup repository if it exists
    const githubLink = gitrepo.info.data.html_url;
    const githubString = "<li>GitHub Link: <a href=\"" + githubLink + "\">" + githubLink + "</a></li>";

    document.getElementById(repository).innerHTML = nameString
        + "<ul>"
        + descString
        + languagesString
        + websiteString
        + pull_string
        + githubString
        + "</ul>";
}

// run js
createTable();

for ( var i in active_repositories ) {
    await addTableElement( active_repositories[ i ] );
}
for ( var i in complete_repositories ) {
    await addTableElement( complete_repositories[ i ] );
}

const repo = accessGitAPI( active_repositories[ 1 ] );
console.log(repo)
</script>

</html>
