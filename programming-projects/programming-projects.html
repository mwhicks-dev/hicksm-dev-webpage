<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/header.css">
    <link rel="stylesheet" href="../css/body.css">
    <title>Mason's Portfolio Site | Programming Projects</title>
</head>
<body>
    <div id="header">
        <nav>
            <div id="nav-menu">
                <ul>
                    <li class="nav-link"><a href="../index.html">Home</a></li>
                    <li class="nav-link"><a href="#">Programming Projects</a></li>
                    <li class="nav-link"><a href="../nick/nick.html">Nick</a></li>
                    <!-- <li class="nav"><a href=""></a></li> -->
                </ul>
            </div>
        </nav>
        <h1>Programming Projects</h1>
    </div>
    <div id="body">
        <table id="projects-table">
            <tr>
                <th>Active</th>
                <th>Complete</th>
            </tr>
        </table>
    </div>
</body>

<script type="module" type="text/javascript">
// init octokit
import { Octokit, App } from "https://esm.sh/octokit";
const octokit = new Octokit({
    auth: generatePAT()
});

// variables
const username = "mwhicks-dev";
const active_flag = "[ACTV]";
const complete_flag = "[COMP]";
const flag_length = active_flag.length == complete_flag.length ? active_flag.length : -1;

let activeRepositories = [];
let completeRepositories = [];

// functions
async function populateRepositories() {
    let repositories = await octokit.request("GET /user/repos");
    repositories = repositories.data
    for ( let i in repositories ) {
        addRepositoryToList( repositories[ i ] );
    }
}

async function addRepositoryToList( repository ) {
    const desc = repository.description;
    if ( desc != null ) {
        const desc_len = desc.length;
        if ( desc_len >= active_flag.length ) {
            const name = repository.name;
            const flag = desc.substring( 0, flag_length );
            if ( flag == active_flag ) {
                activeRepositories.push( name );
            } else if ( flag == complete_flag ) {
                completeRepositories.push( name );
            }
        }
    }
}

function generatePAT() {
    /**
     * Absolutely ridiculous token generation thing I have to do in order to access public info
     * through API without GitHub crying and sobbing and throwing up
     * There is such a thing as too much security. This is literally just to get a public repo keys
     * for my account, to load information that users can access without even logging into GitHub.
     * I am pressed
     */
    const pat = 'ghp_i2pfADH0PaddD1uFTF' + 'O6Xol2IyMdh34bGNr6';

    return pat;
}

function createTable() {
    const active_len = activeRepositories.length;
    const complete_len = completeRepositories.length;

    if ( Number.isNaN( active_len ) )  active_len = 0;
    if ( Number.isNaN( complete_len ) )  complete_len = 0;

    const table_height = active_len > complete_len ? active_len : complete_len;

    const table = document.getElementById("projects-table")
    for ( let i = 0; i < table_height; i++ ) {
        let row = document.createElement("tr");
        let activeColumn = document.createElement("td");
        let completeColumn = document.createElement("td");

        if ( i < active_len ) { activeColumn.id = activeRepositories[ i ]; }
        if ( i < complete_len ) { activeColumn.id = completeRepositories[ i ]; }

        row.appendChild( activeColumn );
        row.appendChild( completeColumn );

        table.appendChild( row );
    }
}

async function accessGitAPI( repository ) {
    const info = await octokit.request("GET /repos/{owner}/{repo}",{
        owner: username,
        repo: repository
    });
    const merged_pulls = await octokit.request("GET /repos/{owner}/{repo}/pulls?state=closed",{
        owner: username,
        repo: repository
    });
    const languages = await octokit.request("GET /repos/{owner}/{repo}/languages",{
        owner: username,
        repo: repository
    });

    return {
        info, merged_pulls, languages
    };
}

async function makeLanguagesPercentage( languages ) {
    const keys = Object.keys( languages );

    let total = 0;
    for ( let i in keys ) {
        const key = keys[ i ];
        total += parseInt( languages[ key ] );
    }
    for ( let i in keys ) {
        const key = keys[ i ];
        languages[ key ] = ( parseInt( 100 * parseInt( languages[ key ] ) / total ) ) + "%";
    }
}

async function addTableElement( repository ) {

    // get repo using async API function
    const gitrepo = await accessGitAPI( repository );

    // create HTML for repository name
    const name = gitrepo.info.data.name;
    const nameString = "<p>Project Title: " + name + "</p>";

    // create HTML for repository description if it exists
    const desc = gitrepo.info.data.description;
    const descString = desc == null ? "" : "<li>Project Description: " + desc.substring( flag_length ) + "</li>";

    // create HTML for repository langauges
    let languages = gitrepo.languages.data
    await makeLanguagesPercentage( languages );
    let languagesString = "<li>Languages:<ul>";

    const languages_keys = Object.keys( languages );
    for ( let i in languages_keys ) {
        const key = languages_keys[ i ];
        const val = languages[ key ];
        languagesString += "<li>" + key + ": " + ( val == "0%" ? "<1%" : val ) + "</li>";
    }
    languagesString += "</ul></li>";

    // create HTML for deployed homepage if it exists
    const website = gitrepo.info.data.homepage;
    const websiteString = website == "" ? "" : "<li>Deployed Website: <a href=\">" + website + "\">" + website + "</a></li>"

    // create HTML for latest pull
    const merged_pulls = gitrepo.merged_pulls.data;
    let pull_string = "";
    if ( merged_pulls.length > 0 ) {
        const latest_pull = merged_pulls[ 0 ];
        pull_string += "<li><p>Latest Pull: " + latest_pull.title + "</p><p>" + latest_pull.body + "</p></li>";
    }

    // create HTML for public githup repository if it exists
    const githubLink = gitrepo.info.data.html_url;
    const githubString = "<li>GitHub Link: <a href=\"" + githubLink + "\">" + githubLink + "</a></li>";

    document.getElementById(repository).innerHTML = nameString
        + "<ul>"
        + descString
        + languagesString
        + websiteString
        + pull_string
        + githubString
        + "</ul>";
}

// run js
await populateRepositories()
createTable();

for ( let i in activeRepositories ) {
    await addTableElement( activeRepositories[ i ] );
}
for ( let i in completeRepositories ) {
    await addTableElement( completeRepositories[ i ] );
}
</script>

</html>
